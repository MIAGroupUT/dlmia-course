

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Tutorial 3 &#8212; Deep Learning in 3D Medical Image Analysis</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://utwente.mia.nl/template/notebooks/Tutorial3_Segmentation/Tutorial3_Segmentation_teacher.html" />
    <link rel="shortcut icon" href="https://www.utwente.nl/.utdesign/img/favicons/favicon-32x32.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/UT_logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/UT_logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Tutorial1_NumpySimpleITK/Tutorial1_NumpySimpleITK_student.html">Tutorial 1</a></li>


</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://jupyter.utwente.nl/hub/user-redirect/git-pull?repo=https%3A//github.com/MIAGroupUT/dlmia-course&urlpath=lab/tree/dlmia-course/jupyter-book/notebooks/Tutorial3_Segmentation/Tutorial3_Segmentation_teacher.ipynb&branch=main" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onJupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/MIAGroupUT/dlmia-course/blob/main/jupyter-book/notebooks/Tutorial3_Segmentation/Tutorial3_Segmentation_teacher.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/MIAGroupUT/dlmia-course" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/MIAGroupUT/dlmia-course/issues/new?title=Issue%20on%20page%20%2Fnotebooks/Tutorial3_Segmentation/Tutorial3_Segmentation_teacher.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/Tutorial3_Segmentation/Tutorial3_Segmentation_teacher.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Tutorial 3</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Tutorial 3</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#may-16-2024">May 16, 2024</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#weights-and-biases">Weights and Biases</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentation-of-chest-x-ray-images">Segmentation of chest X-ray images</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-management">Data management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#build-a-cachedataset">Build a CacheDataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-visualization">Image visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-transforms">Data transforms</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dataloader">Dataloader</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#validation-set">Validation set</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-the-neural-network-loss-function-and-optimizer">Setting up the neural network, loss function, and optimizer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loss-function">Loss function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#choose-an-optimizer">Choose an optimizer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-the-training-loop">Setting up the training loop</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-the-trained-network">Evaluate the trained network</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-inspection">Visual inspection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-evaluation-metrics">Compute evaluation metrics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dice">Dice</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hausdorff-distance">Hausdorff distance</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-to-baseline-masks">Comparison to baseline masks</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-multilabel-classification">Part 3: Multilabel classification</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="tutorial-3">
<h1>Tutorial 3<a class="headerlink" href="#tutorial-3" title="Permalink to this heading">#</a></h1>
<section id="may-16-2024">
<h2>May 16, 2024<a class="headerlink" href="#may-16-2024" title="Permalink to this heading">#</a></h2>
<p>In the last two tutorials, you’ve taken your first steps in PyTorch and trained your first (convolutional) neural networks. You know now what convolution and cross-correlation do and what the essential steps in training a network are.</p>
<p>This week, you will train convolutional neural networks for 2D image segmentation. Everything you do and learn here can be easily applied to 3D images. The data that we will be using today consists of chest X-ray images. The end goal in this dataset is to segment the ribs in these images, as in the image below. However, we will start a bit simpler and just segment every pixel that is a rib.</p>
<p><img src="https://vindr.ai/wp-content/uploads/2021/06/xrib-1.png.pagespeed.ic.yhPrlYfYEN.webp" width=600px></img></p>
<p>First, we set the data path. You can get the required images by downloading the folder “Tutorial 3” <a class="reference external" href="https://surfdrive.surf.nl/files/index.php/s/vnA6J0xAhyzoYuz">here</a> and uploading the folder to your coding environment.</p>
<div class="attention admonition">
<p class="admonition-title">Direct download</p>
<p>You can also directly download the file to your programming environment. If you are using the UT Jupyter server (as most of you are), open a terminal window on the server and run</p>
<p><code class="docutils literal notranslate"><span class="pre">wget</span> <span class="pre">-O</span> <span class="pre">ribs.zip</span> <span class="pre">https://surfdrive.surf.nl/files/index.php/s/Y4psc2pQnfkJuoT/download</span></code>. This will download the file <code class="docutils literal notranslate"><span class="pre">ribs.zip</span></code>. Then, unzip this file by running <code class="docutils literal notranslate"><span class="pre">unzip</span> <span class="pre">ribs.zip</span></code> and you should find all image files on the server.</p>
</div>
<p>Set the data path to the “ribs” folder in the package that you have just downloaded in the code block beneath. If you’re running this on Colab, don’t forget to set a GPU runtime!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ⌨️ add path:</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="s2">&quot;../data/Tutorial_3/ribs&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># check if data_path exists:</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please update your data path to an existing folder.&quot;</span><span class="p">)</span>
<span class="k">elif</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">))):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please update your data path to the correct folder (should contain train, val and test folders).&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Congrats! You selected the correct folder :)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span># Install additional packages required for this tutorial
!pip install scikit-image
!pip install wandb
!pip install monai
</pre></div>
</div>
</div>
</div>
<p><img src="https://i.imgur.com/KISYcqD.png" width=400px></img></p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="weights-and-biases">
<h1>Weights and Biases<a class="headerlink" href="#weights-and-biases" title="Permalink to this heading">#</a></h1>
<p>In the previous tutorial, you have trained a neural network and monitored the loss curves in a Jupyter notebook. You can imagine that if you train multiple networks with different settings, it’s easy to lose track of all loss curves and figure out which model is best. Luckily, there exist excellent so-called MLOps systems to keep track of your experiments. Examples are Tensorboard, Neptune, and Weights &amp; Biases (wandb). Here, we will give you some tips on how to use this last one to keep track of your experiments. Setting everything up is a simple process:</p>
<ol class="arabic simple">
<li><p>Register an account at <a class="reference external" href="https://wandb.ai/site">https://wandb.ai/site</a>. Your projects and runs will be shown on this website, which is accessible from anywhere.</p></li>
<li><p>Run the cell below (including <code class="docutils literal notranslate"><span class="pre">wandb.login()</span></code>) to sign into your account. You will have to paste an API key, which you can find at <a class="reference external" href="https://wandb.ai/authorize">https://wandb.ai/authorize</a>, and hit Enter.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">wandb</span>
<span class="n">wandb</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we can initialize a run in wandb with <code class="docutils literal notranslate"><span class="pre">wandb.init()</span></code>. You can specify the project and run name, as well as configuration settings, by passing these as additional arguments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">run</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s1">&#39;Example project&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Example run&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dataset&#39;</span><span class="p">:</span> <span class="s1">&#39;VinDr-RibCXR&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>By running the code above, a new run is created. Although we have not logged any information yet, it is possible to see the run on the wandb website. As soon as we will start logging information, it will become visible. It is possible to log information to your run with <code class="docutils literal notranslate"><span class="pre">wandb.log()</span></code>. When it’s time to complete the run, you can stop it with <code class="docutils literal notranslate"><span class="pre">run.finish()</span></code>. Run the cell below and see what happens on the run webpage.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># time.sleep(1) makes the script wait for 1 second, so the full script takes about 60 seconds to finish</span>
<span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">):</span>
    <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="s1">&#39;Loss&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="s1">&#39;Accuracy&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()})</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
<span class="n">run</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>In the remainder of this notebook, we will use wandb to log our loss values to a run webpage. In this way, it is easier to keep track of multiple losses and to compare several runs.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="segmentation-of-chest-x-ray-images">
<h1>Segmentation of chest X-ray images<a class="headerlink" href="#segmentation-of-chest-x-ray-images" title="Permalink to this heading">#</a></h1>
<p>In this part of the tutorial, you will train a convolutional neural network for automatic segmentation of ribs in a chest X-ray image. You will examine the effects of using different loss functions, data augmentations and network architectures. To keep track of all these parameters, we will use wandb.</p>
<section id="data-management">
<h2>Data management<a class="headerlink" href="#data-management" title="Permalink to this heading">#</a></h2>
<section id="build-a-cachedataset">
<h3>Build a CacheDataset<a class="headerlink" href="#build-a-cachedataset" title="Permalink to this heading">#</a></h3>
<p>At the beginning of the notebook, you defined the path to the rib data. We will now use it to find and load the corresponding images.
The data consists of an image and a label. However, the label is in this case not a binary label, but a segmentation mask. Both the segmentation masks and the X-rays are .png files and can be opened using the PIL library.</p>
<p>For this tutorial we are not going to code the Dataset class ourselves but instead use a Monai class: <a class="reference external" href="https://docs.monai.io/en/stable/data.html#cachedataset"><code class="docutils literal notranslate"><span class="pre">CacheDataset</span></code></a>. It has two main advantages:</p>
<ul class="simple">
<li><p>as the name suggests, it uses a <a class="reference external" href="https://en.wikipedia.org/wiki/Cache_(computing)">cache</a> mechanism, which means that it is memory efficient (this is partly explained later).</p></li>
<li><p>everything is pre-built, so no need to code the <code class="docutils literal notranslate"><span class="pre">__init__</span></code>, <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> and <code class="docutils literal notranslate"><span class="pre">__len__</span></code> functions anymore.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">CacheDataset</span></code> only needs the list of your data samples to work. As we are learning a segmentation task, one data sample is composed of two images: the chest X-ray (named <code class="docutils literal notranslate"><span class="pre">img</span></code>) and the mask of the ribs (named <code class="docutils literal notranslate"><span class="pre">mask</span></code>). With Python, we represent this data sample with a dictionary:</p>
<img src="https://i.imgur.com/yLI4sJz.png" alt="sample" width="450"/>
<p>Then we could give this kind of list to <code class="docutils literal notranslate"><span class="pre">CacheDataset</span></code> to create our data set:</p>
<img src="https://i.imgur.com/r7JJTgY.png" alt="list of samples" width="500"/>
<p>However, as this list contains all the images, it means that all the images are always in Python memory even though they are not currently used so this is very inefficient. This is why we don’t directly give  the images to <code class="docutils literal notranslate"><span class="pre">CacheDataset</span></code>, but the paths to find them on our disk. Then we also need to give a <code class="docutils literal notranslate"><span class="pre">Transform</span></code> object, <code class="docutils literal notranslate"><span class="pre">LoadRibData</span></code> which will transform these paths into the corresponding images only when they are needed.</p>
<img src="https://i.imgur.com/JacrPFO.png" alt="list of paths" width="650"/>
<img src="https://i.imgur.com/EUWJj4r.png" alt="transform path to image" width="430"/>
<p>As we don’t want to write this list of paths manually, we write the function <code class="docutils literal notranslate"><span class="pre">build_dict_ribs</span></code> which automatically computes it based on the root folder of the data directory <code class="docutils literal notranslate"><span class="pre">data_path</span></code>. This is possible because fortunately your teachers pre-organized the dataset for this tutorial, but be aware that most medical datasets require a lot of cleaning up prior to this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">monai</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="k">def</span> <span class="nf">build_dict_ribs</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function returns a list of dictionaries, each dictionary containing the keys &#39;img&#39; and &#39;mask&#39; </span>
<span class="sd">    that returns the path to the corresponding image.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        data_path (str): path to the root folder of the data set.</span>
<span class="sd">        mode (str): subset used. Must correspond to &#39;train&#39;, &#39;val&#39; or &#39;test&#39;.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        (List[Dict[str, str]]) list of the dictionaries containing the paths of X-ray images and masks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># test if mode is correct</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please choose a mode in [&#39;train&#39;, &#39;val&#39;, &#39;test&#39;]. Current mode is </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    
    <span class="c1"># define empty dictionary</span>
    <span class="n">dicts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># list all .png files in directory, including the path</span>
    <span class="n">paths_xray</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;*.png&#39;</span><span class="p">))</span>
    <span class="c1"># make a corresponding list for all the mask files</span>
    <span class="k">for</span> <span class="n">xray_path</span> <span class="ow">in</span> <span class="n">paths_xray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;val&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="c1"># find the binary mask that belongs to the original image, based on indexing in the filename</span>
        <span class="n">image_index</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">xray_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># define path to mask file based on this index and add to list of mask paths</span>
        <span class="n">mask_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;VinDr_RibCXR_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">image_index</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mask_path</span><span class="p">):</span>
            <span class="n">dicts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;img&#39;</span><span class="p">:</span> <span class="n">xray_path</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span> <span class="n">mask_path</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">dicts</span>

<span class="k">class</span> <span class="nc">LoadRibData</span><span class="p">(</span><span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Transform</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This custom Monai transform loads the data from the rib segmentation dataset.</span>
<span class="sd">    Defining a custom transform is simple; just overwrite the __init__ function and __call__ function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="c1"># import as grayscale image</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="c1"># import as grayscale image</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="c1"># mask has value 255 on rib pixels. Convert to binary array</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="o">==</span><span class="mi">255</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;img&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span> <span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;img_meta_dict&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;affine&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)},</span> 
                <span class="s1">&#39;mask_meta_dict&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;affine&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)}}</span>
</pre></div>
</div>
</div>
</div>
<div class="note admonition">
<p class="admonition-title">Note</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">LoadRibData</span></code> is now outputing a much more complex dictionary with two additional keys: <code class="docutils literal notranslate"><span class="pre">img_meta_dict</span></code> and <code class="docutils literal notranslate"><span class="pre">mask_meta_dict</span></code>. These contain respectively the meta data of <code class="docutils literal notranslate"><span class="pre">img</span></code> and <code class="docutils literal notranslate"><span class="pre">mask</span></code>: here we decided to add the resolution of the image, corresponding to the key <code class="docutils literal notranslate"><span class="pre">affine</span></code>. This will be useful for Monai to perform some transformations later.</p>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">CacheDataset</span></code> needs two arguments to perform our procedure</p>
<ol class="arabic simple">
<li><p>The list of samples (represented by dictionaries) which is computed by <code class="docutils literal notranslate"><span class="pre">build_dict_ribs</span></code>.</p></li>
<li><p>A transform object, <code class="docutils literal notranslate"><span class="pre">LoadRibData</span></code>, which will transform the paths in the previous list into images.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct list of dictionaries</span>
<span class="n">train_dict_list</span> <span class="o">=</span> <span class="n">build_dict_ribs</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
<span class="c1"># construct CacheDataset from list of paths + transform</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">CacheDataset</span><span class="p">(</span><span class="n">train_dict_list</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">LoadRibData</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>How many samples are in the training, validation, and test set?</p>
</div>
<div class="seealso admonition">
<p class="admonition-title">Answer key</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">val_dict_list</span> <span class="o">=</span> <span class="n">build_dict_ribs</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">)</span>
<span class="n">test_dict_list</span> <span class="o">=</span> <span class="n">build_dict_ribs</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">CacheDataset</span><span class="p">(</span><span class="n">val_dict_list</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">LoadRibData</span><span class="p">())</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">CacheDataset</span><span class="p">(</span><span class="n">test_dict_list</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">LoadRibData</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">train_dataset</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">val_dataset</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">test_dataset</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>What are the dimensions of the images? Are they all equal? Will this a problem when training a CNN for segmentation?</p>
</div>
<div class="seealso admonition">
<p class="admonition-title">Answer key</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="si">=}</span><span class="s1">, </span><span class="si">{</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>They are different, which means that we can’t stack them in mini-batches.</p>
</div>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>What is the pixel intensity range of the images? Are they similar? Will this be a problem when training a CNN for segmentation?</p>
<p>Visualize the pixel intensity range of a bunch of images. <strong>Hint</strong> Use Matplotlib <code class="docutils literal notranslate"><span class="pre">hist</span></code> (<a class="reference external" href="https://matplotlib.org/3.5.0/api/_as_gen/matplotlib.pyplot.hist.html">documentation</a>) and <code class="docutils literal notranslate"><span class="pre">.flatten()</span></code> your image (or you will get &gt;2000 histograms per image)</p>
</div>
<div class="seealso admonition">
<p class="admonition-title">Answer key</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="image-visualization">
<h3>Image visualization<a class="headerlink" href="#image-visualization" title="Permalink to this heading">#</a></h3>
<p>We now build <code class="docutils literal notranslate"><span class="pre">visualize_rib_sample</span></code> to plot X-ray images on which we overlay their binary mask (in green).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">visualize_rib_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Visualize the x-ray and overlay the mask, using the dictionary as input</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">])</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">overlay_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">overlay_mask</span><span class="p">,</span> <span class="s1">&#39;Greens&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">visualize_rib_sample</span></code> to visualize samples from the training set.</p>
</div>
<div class="seealso admonition">
<p class="admonition-title">Answer key</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sample_dict</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">visualize_rib_sample</span><span class="p">(</span><span class="n">sample_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="data-transforms">
<h3>Data transforms<a class="headerlink" href="#data-transforms" title="Permalink to this heading">#</a></h3>
<p>The training dataset that you have created in the previous step is quite small. In order to improve the generalization of the network, we are going to do some <strong>data augmentation</strong>. This can be easily implemented in the pipeline using the <a class="reference external" href="https://docs.monai.io/en/stable/transforms.html#">transforms</a> in Monai.</p>
<div class="note admonition">
<p class="admonition-title">Data augmentation</p>
<p><a class="reference external" href="https://d2l.ai/chapter_computer-vision/image-augmentation.html#image-augmentation">Data augmentation</a> is a very common way to enlarge the number of training samples that you use. By applying transformations such as rotation, flipping, scaling to images we <em>artificially</em> enlarge the number of samples that the model sees.</p>
</div>
<p>Monai distinguishes <em>deterministic</em> and <em>random</em> transforms:</p>
<ul class="simple">
<li><p><em>Deterministic</em> transforms do the exact same thing every time they are called, for example intensity normalization will always have the same outcome.</p></li>
<li><p><em>Random</em> transforms can be rotations or flips that do not have the same outcome each time they are called.</p></li>
</ul>
<p>The random transforms (for example flipping and rotation) need to be performed in the same way on the input image <code class="docutils literal notranslate"><span class="pre">'img'</span></code> as well as on the label <code class="docutils literal notranslate"><span class="pre">'mask'</span></code>. Monai has <a class="reference external" href="https://docs.monai.io/en/stable/transforms.html#dictionary-transforms">adapted transforms</a> that take dictionaries as an input, such that random transforms can be performed in the same way for both images: you don’t want a different angle of rotation for the image and the mask, as they will become misaligned! You can recognize these transforms as they end with a ‘d’, e.g. <code class="docutils literal notranslate"><span class="pre">Zoomd</span></code> instead of <code class="docutils literal notranslate"><span class="pre">Zoom</span></code>.</p>
<img src="https://i.imgur.com/I7BErgj.png" alt="rotated sample" width="650"/>
<p>The examples below show how to use one of these dictionary transforms to perform a random horizontal flip and a random rotation. The procedure of applying a transform from Monai consists of two steps:</p>
<ol class="arabic simple">
<li><p>Initialize the transform: here you build the object and pass the init variables, such as the probability or range of rotation, and in case of a dictionary transform the keys of the dictionary.</p></li>
<li><p>Apply the transform on a data sample</p></li>
</ol>
<p>Lastly, most transforms expect a channel dimension for both 2D and 3D images. As we have only one channel, we should add this extra dimension using the <code class="docutils literal notranslate"><span class="pre">monai.transforms.AddChanneld</span></code> transform first.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load sample</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)))</span> <span class="c1"># This picks a random sample, but you can change this value</span>
<span class="n">sample_dict</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
<span class="n">visualize_rib_sample</span><span class="p">(</span><span class="n">sample_dict</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Original sample&quot;</span><span class="p">)</span>

<span class="c1"># Add channels</span>
<span class="n">add_channels_transform</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AddChanneld</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">])</span> <span class="c1"># Initialize the transform</span>
<span class="n">channels_sample_dict</span> <span class="o">=</span> <span class="n">add_channels_transform</span><span class="p">(</span><span class="n">sample_dict</span><span class="p">)</span> <span class="c1"># Apply the transform</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Size of the image before AddChanneld transform&quot;</span><span class="p">,</span> <span class="n">sample_dict</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Size of the image after AddChanneld transform&quot;</span><span class="p">,</span> <span class="n">channels_sample_dict</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Random flip</span>
<span class="c1"># here we define the keys, the probability that the flip is performed and the axis to flip over</span>
<span class="n">random_flip_transform</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">RandFlipd</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">spatial_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># We put a probability of 1 to always flip the image for visualization purposes.</span>
<span class="c1"># Please DO NOT DO THAT in the rest of the notebook.</span>
<span class="n">flipped_sample_dict</span> <span class="o">=</span> <span class="n">random_flip_transform</span><span class="p">(</span><span class="n">channels_sample_dict</span><span class="p">)</span>
<span class="n">visualize_rib_sample</span><span class="p">(</span><span class="n">flipped_sample_dict</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;(Not quite randomly) flipped sample&quot;</span><span class="p">)</span>

<span class="c1"># Random rotation</span>
<span class="c1"># Here we define the keys in the dictionary that contain the data, the rotation range, but also the interpolation mode. </span>
<span class="c1"># The interpolation mode defines how new pixel values for the rotated image are computed. </span>
<span class="c1"># Note that these differ between mask and image, as we want to keep binary labels for the masks, and (bi)linear interpolation</span>
<span class="c1"># would result in scalar values between 0 and 1.</span>
<span class="n">random_rotation_transform</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">RandRotated</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">range_x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span><span class="p">])</span>
<span class="n">rotated_sample_dict</span> <span class="o">=</span> <span class="n">random_rotation_transform</span><span class="p">(</span><span class="n">channels_sample_dict</span><span class="p">)</span>
<span class="n">visualize_rib_sample</span><span class="p">(</span><span class="n">rotated_sample_dict</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Randomly rotated sample&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note how we concatenated the <code class="docutils literal notranslate"><span class="pre">AddChannelsd</span></code> transform with the flip and rotate transform by applying them after each other. If we have only two transforms, like here, this is an acceptable workflow. However, if we have a whole bunch of transforms that we have to call during training of the network, you can imagine that the code will become very messy. Therefore, we can combine multiple transforms into a single one using <a class="reference external" href="https://docs.monai.io/en/stable/transforms.html#compose"><code class="docutils literal notranslate"><span class="pre">monai.transforms.Compose</span></code></a>.</p>
<p>Upon initialization, <code class="docutils literal notranslate"><span class="pre">Compose</span></code> takes a list of transforms as input and outputs a transform object that concatenates all the transforms. It can be applied in the same way as the transforms shown above.</p>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">Compose</span></code> class of Monai to compose <code class="docutils literal notranslate"><span class="pre">AddChanneld</span></code>, <code class="docutils literal notranslate"><span class="pre">RandFlipd</span></code> and <code class="docutils literal notranslate"><span class="pre">RandRotated</span></code> in a single transform. Then apply this composition to a data set sample.</p>
</div>
<div class="seealso admonition">
<p class="admonition-title">Answer key</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sample_dict</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Create the composed transform</span>
<span class="n">add_channels_transform</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AddChanneld</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">])</span> <span class="c1"># Initialize the transform</span>
<span class="n">random_flip_transform</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">RandFlipd</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">spatial_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">random_rotation_transform</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">RandRotated</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">range_x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span><span class="p">])</span>

<span class="n">transforms</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">add_channels_transform</span><span class="p">,</span>
    <span class="n">random_flip_transform</span><span class="p">,</span>
    <span class="n">random_rotation_transform</span>
<span class="p">])</span>

<span class="c1"># Apply this new single transform to sample_dict</span>
<span class="n">transformed_sample</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">(</span><span class="n">sample_dict</span><span class="p">)</span>
<span class="n">visualize_rib_sample</span><span class="p">(</span><span class="n">transformed_sample</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Transformed sample&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="note admonition">
<p class="admonition-title">Efficiency</p>
<p>As mentioned before, there is a distinction between random and deterministic transforms. This distinction is important, as their order can have a huge influence on computational efficiency. The <a class="reference external" href="https://docs.monai.io/en/stable/data.html#cachedataset">CacheDataset</a> class stores the outcomes of all deterministic transforms in memory, and performs the random transforms on-the-fly. Therefore, placing the deterministic transforms before the random ones in combination with caching results in a training and inference procedure will result in higher computational efficiency.</p>
</div>
<p>We are going to use the following three transforms in the X-ray segmentation task</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Zoom</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RandomFlip</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RandSpatialCrop</span></code></p></li>
</ul>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>Compose the <code class="docutils literal notranslate"><span class="pre">AddChannel</span></code>, <code class="docutils literal notranslate"><span class="pre">ScaleIntensity</span></code>, <code class="docutils literal notranslate"><span class="pre">Zoom</span></code>, <code class="docutils literal notranslate"><span class="pre">RandomFlip</span></code> and <code class="docutils literal notranslate"><span class="pre">RandSpatialCrop</span></code> transforms in a computationally efficient order and construct a new training dataset (with <code class="docutils literal notranslate"><span class="pre">CacheDataset</span></code>) using these transforms.</p>
<ol class="arabic simple">
<li><p>Make sure to visualize some samples to see if the transforms are working as you expect.</p></li>
<li><p>Don’t forget to put <code class="docutils literal notranslate"><span class="pre">LoadRibData</span></code> as your first transform or your dataset will try to rotate strings representing the paths of your images…</p></li>
<li><p>If you identified problems in the previous sections it is time to solve them!</p></li>
</ol>
</div>
<div class="admonition-answer-key admonition">
<p class="admonition-title">Answer key</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">train_transform</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">LoadRibData</span><span class="p">(),</span>
    <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AddChanneld</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">]),</span>
    <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ScaleIntensityd</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">],</span><span class="n">minv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxv</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Zoomd</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">zoom</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">keep_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span><span class="p">]),</span>
    <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">RandFlipd</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">spatial_axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">RandSpatialCropd</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">roi_size</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">],</span> <span class="n">random_size</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">CacheDataset</span><span class="p">(</span><span class="n">train_dict_list</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">train_transform</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">visualize_rib_sample</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Transformed sample </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="dataloader">
<h3>Dataloader<a class="headerlink" href="#dataloader" title="Permalink to this heading">#</a></h3>
<p>We use mini-batch gradient descent during training, so we want to sample batches to train the network on, rather than single instances of the data. For this we use <code class="docutils literal notranslate"><span class="pre">monai.data.DataLoader</span></code>, which efficiently samples batches from the data that can be fed into the network right away. Remember that you have also used a <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> in Tutorial 2.</p>
<p>This <a class="reference external" href="https://pytorch.org/tutorials/beginner/basics/data_tutorial.html">PyTorch tutorial</a> provides more information about datasets and dataloaders.</p>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>Construct a dataloader with randomly sampled mini-batches of 16 images for the training set.</p>
</div>
<div class="seealso admonition">
<p class="admonition-title">Answer key</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">train_loader</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">))[</span><span class="s1">&#39;img&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="validation-set">
<h3>Validation set<a class="headerlink" href="#validation-set" title="Permalink to this heading">#</a></h3>
<p>During training, we want to keep an eye on how the network generalizes to unseen data. It could perform very well on its training set, whereas it performs poorly on unseen data (overfitting). For this, we need to construct a validation set consisting of comparable but different samples of data than the training set. For our data, it can be constructed in a similar way as the train set:</p>
<ol class="arabic simple">
<li><p>Construct the dictionary of file paths</p></li>
<li><p>Define the transforms that should be applied on the validation data</p></li>
<li><p>Construct the CacheDataset using the dictionary and transform</p></li>
<li><p>Build a validation dataloader using from the CacheDataset</p></li>
</ol>
<p>In contrast to the training set, we don’t apply data augmentation to the validation set. This is important to keep in mind when defining transforms.</p>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>Build a validation dataset and dataloader using these steps. Create a separate validation transform.</p>
</div>
<div class="seealso admonition">
<p class="admonition-title">Answer key</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">validation_dict</span> <span class="o">=</span> <span class="n">build_dict_ribs</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;val&#39;</span><span class="p">)</span>

<span class="n">validation_transforms</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">LoadRibData</span><span class="p">(),</span>
    <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AddChanneld</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">]),</span>
    <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ScaleIntensityd</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">],</span><span class="n">minv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxv</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Resized</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">spatial_size</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">])</span>
<span class="p">])</span>
<span class="n">validation_data</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">CacheDataset</span><span class="p">(</span><span class="n">validation_dict</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">validation_transforms</span><span class="p">)</span>
<span class="n">validation_loader</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">validation_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">validation_loader</span><span class="p">))[</span><span class="s1">&#39;img&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="setting-up-the-neural-network-loss-function-and-optimizer">
<h2>Setting up the neural network, loss function, and optimizer<a class="headerlink" href="#setting-up-the-neural-network-loss-function-and-optimizer" title="Permalink to this heading">#</a></h2>
<img src="https://lmb.informatik.uni-freiburg.de/people/ronneber/u-net/u-net-architecture.png" alt="drawing" width="600"/>
<p>Now that we have the data loading process out of the way, we set up a U-Net, a loss function, and an optimizer. If possible, use a GPU to substantially speed up computing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The used device is </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Setting up a <a class="reference external" href="https://arxiv.org/abs/1505.04597">U-Net</a> for segmentation in MONAI is as easy as calling the <code class="docutils literal notranslate"><span class="pre">UNet</span></code> function and providing it with the number of input channels, output channels, and feature maps/channels in the intermediate layers. The following provides us with a model that is optimized during training to perform segmentation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">networks</span><span class="o">.</span><span class="n">nets</span><span class="o">.</span><span class="n">UNet</span><span class="p">(</span>
    <span class="n">spatial_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">out_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">channels</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">),</span>
    <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="n">num_res_units</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>How many levels does the U-Net have? And how many parameters does it have (use the code from last tutorial)?</p>
</div>
<div class="seealso admonition">
<p class="admonition-title">Answer key</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">num_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;U-Net has 5 layers (see &quot;channels&quot; parameter) and </span><span class="si">{</span><span class="n">num_params</span><span class="si">}</span><span class="s1"> parameters&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="loss-function">
<h3>Loss function<a class="headerlink" href="#loss-function" title="Permalink to this heading">#</a></h3>
<p>The loss function should reflect what we want the training model to be able to do.
For segmentation, a popular function to use for training the network is the <a class="reference external" href="https://en.wikipedia.org/wiki/S%C3%B8rensen%E2%80%93Dice_coefficient">Dice loss</a>, which measures the overlap between the ground-truth and the model prediction. Monai offers a wide range of different <a class="reference external" href="https://docs.monai.io/en/stable/losses.html">loss functions</a> that are also suitable for segmentation. In this tutorial, we will also assess the effects of using different loss functions on our network performance.</p>
<p>We show how to implement the Dice function in this example. Our network only has one output channel. In order to have all the output values between 0 and 1, so we can compute the Dice, the function first applies a <a class="reference external" href="https://en.wikipedia.org/wiki/Sigmoid_function">logistic sigmoid</a>. The Dice loss is computed over the full mini-batch (<code class="docutils literal notranslate"><span class="pre">batch=True</span></code>) to avoid poorly defined loss in individual batch samples. This means that, in a sense, we compute the Dice loss in a 3D stack of 2D images.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">loss_function</span> <span class="o">=</span>  <span class="n">monai</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">DiceLoss</span><span class="p">(</span><span class="n">sigmoid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="choose-an-optimizer">
<h3>Choose an optimizer<a class="headerlink" href="#choose-an-optimizer" title="Permalink to this heading">#</a></h3>
<p>An optimizer algorithm is chosen that performs gradient descent on the network parameters to minimize the loss function. Last week you have used SGD (stochastic gradient descent). In many cases, <a class="reference external" href="https://arxiv.org/abs/1412.6980">Adam</a> is a good default option. The optimizer operates on the parameters of the previously defined U-Net, i.e. <code class="docutils literal notranslate"><span class="pre">model</span></code>. A learning rate <code class="docutils literal notranslate"><span class="pre">lr</span></code> is provided to the optimizer, which defines how large the changes should be that are made to the network parameters in each iteration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="setting-up-the-training-loop">
<h3>Setting up the training loop<a class="headerlink" href="#setting-up-the-training-loop" title="Permalink to this heading">#</a></h3>
<p>In the previous tutorial, we explained how to set up a simple loop for training your network. For training this network, the loop can be set up in a similar way.
Instead of keeping track of the train and validation loss on your computer, you can <a class="reference external" href="https://docs.wandb.ai/guides/track/log">log</a> everything in weights and biases.</p>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>Set up a simple loop for training the network and log the following in weights and biases:</p>
<ul class="simple">
<li><p>Loss function</p></li>
<li><p>Learning rate</p></li>
<li><p>Training loss</p></li>
<li><p>Validation loss</p></li>
<li><p>Some validation images, including segmentation masks that display model output and the ground truth (see <a class="reference external" href="https://docs.wandb.ai/guides/track/log/media#image-overlays">W&amp;B documentation</a>).</p></li>
</ul>
<p>Below, we provide a <code class="docutils literal notranslate"><span class="pre">log_to_wandb()</span></code> function that you could use for this. Just call it once at the end of every epoch, with the right arguments.</p>
</div>
<div class="seealso admonition">
<p class="admonition-title">Answer key</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">wandb</span>

<span class="n">run</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
    <span class="n">project</span><span class="o">=</span><span class="s1">&#39;tutorial3_segmentation&#39;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;loss function&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">loss_function</span><span class="p">),</span> 
        <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">],</span>
        <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">from_compose_to_list</span><span class="p">(</span><span class="n">train_transform</span><span class="p">),</span>
        <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="n">train_loader</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="c1"># Do not hesitate to enrich this list of settings to be able to correctly keep track of your experiments!</span>
<span class="c1"># For example you should add information on your model...</span>

<span class="n">run_id</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">id</span> <span class="c1"># We remember here the run ID to be able to write the evaluation metrics</span>

<span class="k">def</span> <span class="nf">wandb_masks</span><span class="p">(</span><span class="n">mask_output</span><span class="p">,</span> <span class="n">mask_gt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function that generates a mask dictionary in format that W&amp;B requires &quot;&quot;&quot;</span>

    <span class="c1"># Apply sigmoid to model ouput and round to nearest integer (0 or 1)</span>
    <span class="n">sigmoid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
    <span class="n">mask_output</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">mask_output</span><span class="p">)</span>
    <span class="n">mask_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mask_output</span><span class="p">)</span>

    <span class="c1"># Transform masks to numpy arrays on CPU</span>
    <span class="c1"># Note: .squeeze() removes all dimensions with a size of 1 (here, it makes the tensors 2-dimensional)</span>
    <span class="c1"># Note: .detach() removes a tensor from the computational graph to prevent gradient computation for it</span>
    <span class="n">mask_output</span> <span class="o">=</span> <span class="n">mask_output</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">mask_gt</span> <span class="o">=</span> <span class="n">mask_gt</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="c1"># Create mask dictionary with class label and insert masks</span>
    <span class="n">class_labels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;ribs&#39;</span><span class="p">}</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;mask_data&#39;</span><span class="p">:</span> <span class="n">mask_output</span><span class="p">,</span> <span class="s1">&#39;class_labels&#39;</span><span class="p">:</span> <span class="n">class_labels</span><span class="p">},</span>
        <span class="s1">&#39;ground truth&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;mask_data&#39;</span><span class="p">:</span> <span class="n">mask_gt</span><span class="p">,</span> <span class="s1">&#39;class_labels&#39;</span><span class="p">:</span> <span class="n">class_labels</span><span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">masks</span>

<span class="k">def</span> <span class="nf">log_to_wandb</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="n">val_loss</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">,</span> <span class="n">outputs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function that logs ongoing training variables to W&amp;B &quot;&quot;&quot;</span>

    <span class="c1"># Create list of images that have segmentation masks for model output and ground truth</span>
    <span class="n">log_imgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">wandb</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">masks</span><span class="o">=</span><span class="n">wandb_masks</span><span class="p">(</span><span class="n">mask_output</span><span class="p">,</span> <span class="n">mask_gt</span><span class="p">))</span> <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">mask_output</span><span class="p">,</span>
                <span class="n">mask_gt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">],</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])]</span>

    <span class="c1"># Send epoch, losses and images to W&amp;B</span>
    <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">({</span><span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span> <span class="s1">&#39;train_loss&#39;</span><span class="p">:</span> <span class="n">train_loss</span><span class="p">,</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="n">val_loss</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">log_imgs</span><span class="p">})</span>
    
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">)):</span>
    
    <span class="c1"># training</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>    
    <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">batch_data</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span> 
        <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">epoch_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">train_loss</span> <span class="o">=</span> <span class="n">epoch_loss</span><span class="o">/</span><span class="n">step</span>
    
    <span class="c1"># validation</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">val_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">batch_data</span> <span class="ow">in</span> <span class="n">validation_loader</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">batch_data</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
        <span class="n">val_loss</span><span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="n">val_loss</span> <span class="o">=</span> <span class="n">val_loss</span> <span class="o">/</span> <span class="n">step</span>
    <span class="n">log_to_wandb</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">train_loss</span><span class="p">,</span> <span class="n">val_loss</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

<span class="c1"># Store the network parameters        </span>
<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="sa">r</span><span class="s1">&#39;trainedUNet.pt&#39;</span><span class="p">)</span>
<span class="n">run</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="evaluate-the-trained-network">
<h1>Evaluate the trained network<a class="headerlink" href="#evaluate-the-trained-network" title="Permalink to this heading">#</a></h1>
<section id="visual-inspection">
<h2>Visual inspection<a class="headerlink" href="#visual-inspection" title="Permalink to this heading">#</a></h2>
<p>We have trained the network on small patches of the image. In order to see how well it performs on the entire image, we can use the <code class="docutils literal notranslate"><span class="pre">monai.inferers.SlidingWindowInferer</span></code>. This ‘slides’ the network over patches of the input image. The overlap between patches can also be controlled.</p>
<p><img alt="sliding" src="https://docs.monai.io/en/stable/_images/sliding_window.png" /></p>
<p>Moreover, we want our final mask to have discrete values (0 or 1). Then, we need to discretize the continuous output of the network. This is why we use <code class="docutils literal notranslate"><span class="pre">Sigmoid</span></code> (clipping the output values between 0 and 1) and <code class="docutils literal notranslate"><span class="pre">AsDiscrete</span></code> (mapping the continuous distribution on the {0, 1} set).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">visual_evaluation</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allow the visual inspection of one sample by plotting the X-ray image, the ground truth (green)</span>
<span class="sd">    and the segmentation map produced by the network (red).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        sample (Dict[str, torch.Tensor]): sample composed of an X-ray (&#39;img&#39;) and a mask (&#39;mask&#39;).</span>
<span class="sd">        model (torch.nn.Module): trained model to evaluate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">inferer</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">inferers</span><span class="o">.</span><span class="n">SlidingWindowInferer</span><span class="p">(</span><span class="n">roi_size</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span>
    <span class="n">discrete_transform</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AsDiscrete</span><span class="p">(</span><span class="n">logit_thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">threshold_values</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Sigmoid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">discrete_transform</span><span class="p">(</span><span class="n">Sigmoid</span><span class="p">(</span><span class="n">inferer</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">network</span><span class="o">=</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
    <span class="c1"># Plot X-ray image</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>    
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="c1"># Plot ground truth</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">])</span>
    <span class="n">overlay_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">overlay_mask</span><span class="p">,</span> <span class="s1">&#39;Greens&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ground truth&#39;</span><span class="p">)</span>
    <span class="c1"># Plot output</span>
    <span class="n">overlay_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">output</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">output</span> <span class="o">&gt;</span><span class="mf">0.99</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">overlay_output</span><span class="p">,</span> <span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Prediction&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test_dict</span> <span class="o">=</span> <span class="n">build_dict_ribs</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
<span class="n">test_transform</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">LoadRibData</span><span class="p">(),</span>
        <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AddChanneld</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">]),</span>
        <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ScaleIntensityd</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">],</span><span class="n">minv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxv</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">Zoomd</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="n">zoom</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">keep_size</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="s1">&#39;nearest&#39;</span><span class="p">]),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">test_set</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">CacheDataset</span><span class="p">(</span><span class="n">test_dict</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">test_transform</span><span class="p">)</span>
<span class="n">test_loader</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
    <span class="n">visual_evaluation</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="compute-evaluation-metrics">
<h2>Compute evaluation metrics<a class="headerlink" href="#compute-evaluation-metrics" title="Permalink to this heading">#</a></h2>
<p>Previously, we evaluated the quality of our segmentation on the test set by visually inspecting the quality of the maps produced by our network. Though this is an essential step when developping and debugging a network, this step is also quite subjective, and tedious when there are a lot of images. This is why we need metrics to evaluate the performance of our network! These metrics give us a quantity that represents the performance of our network and enable comparison to other methods.</p>
<p>We provide the function <code class="docutils literal notranslate"><span class="pre">compute_metric</span></code> to evaluate the performance of the network on the segmentation task. Similar to the transforms and loss functions, Monai contains many <a class="reference external" href="https://docs.monai.io/en/stable/metrics.html">evaluation metrics</a> to assess the model’s performance. We show how to compute the Dice metric for the network.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_metric</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">metric_fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function computes the average value of a metric for a data set.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        dataloader (monai.data.DataLoader): dataloader wrapping the dataset to evaluate.</span>
<span class="sd">        model (torch.nn.Module): trained model to evaluate.</span>
<span class="sd">        metric_fn (function): function computing the metric value from two tensors:</span>
<span class="sd">            - a batch of outputs,</span>
<span class="sd">            - the corresponding batch of ground truth masks.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        (float) the mean value of the metric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">inferer</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">inferers</span><span class="o">.</span><span class="n">SlidingWindowInferer</span><span class="p">(</span><span class="n">roi_size</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span>
    <span class="n">discrete_transform</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AsDiscrete</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">Sigmoid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
    
    <span class="n">mean_value</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">discrete_transform</span><span class="p">(</span><span class="n">Sigmoid</span><span class="p">(</span><span class="n">inferer</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">network</span><span class="o">=</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()))</span>
        <span class="n">mean_value</span> <span class="o">+=</span> <span class="n">metric_fn</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">mean_value</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>As we want to log everything in the corresponding run with W&amp;B, we access to the corresponding run with <code class="docutils literal notranslate"><span class="pre">wandb.Api()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">api</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Api</span><span class="p">()</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tutorial3_segmentation/</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="dice">
<h3>Dice<a class="headerlink" href="#dice" title="Permalink to this heading">#</a></h3>
<p>This is the same metric that the one that was used for the loss function.</p>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>Find the appropriate function in <a class="reference external" href="https://docs.monai.io/en/stable/metrics.html"><code class="docutils literal notranslate"><span class="pre">monai.metrics</span></code></a> to compute the mean Dice with <code class="docutils literal notranslate"><span class="pre">compute_metric</span></code>.</p>
</div>
<div class="seealso admonition">
<p class="admonition-title">Answer key</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">metric_fn</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_meandice</span>
<span class="n">dice</span> <span class="o">=</span> <span class="n">compute_metric</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">metric_fn</span><span class="p">)</span>
<span class="n">run</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s2">&quot;dice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dice</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dice on test set: </span><span class="si">{</span><span class="n">dice</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="hausdorff-distance">
<h3>Hausdorff distance<a class="headerlink" href="#hausdorff-distance" title="Permalink to this heading">#</a></h3>
<p>The Hausdorff distance uses a function f which computes the minimal distance between the farthest point that can be found in a set Y compared to another set X. The Hausdorff takes the worst case between f(X,Y) and f(Y,X).</p>
<img src="https://i.imgur.com/V7XL8eU.png" alt="illustration of Hausdorff distance from Wikipedia" width="200"/>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>Find the appropriate function in <a class="reference external" href="https://docs.monai.io/en/stable/metrics.html"><code class="docutils literal notranslate"><span class="pre">monai.metrics</span></code></a> to compute the Hausdorff distance with <code class="docutils literal notranslate"><span class="pre">compute_metric</span></code>.</p>
</div>
<div class="seealso admonition">
<p class="admonition-title">Answer key</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">metric_fn</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_hausdorff_distance</span>
<span class="n">Hausdorff_dist</span> <span class="o">=</span> <span class="n">compute_metric</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">metric_fn</span><span class="p">)</span>
<span class="n">run</span><span class="o">.</span><span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Hausdorff_dist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Hausdorff_dist</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hausdorff distance on test set: </span><span class="si">{</span><span class="n">Hausdorff_dist</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>Are you happy with the performance of your model? Can you think of ways to improve the performance?</p>
</div>
</section>
</section>
<section id="comparison-to-baseline-masks">
<h2>Comparison to baseline masks<a class="headerlink" href="#comparison-to-baseline-masks" title="Permalink to this heading">#</a></h2>
<p>Although you did some visual inspection of the outputs of the model, interpretation of the Dice scores and Hausdorff distances is <a class="reference external" href="https://arxiv.org/abs/2104.05642">not trivial</a>. Therefore, comparing to a baseline model for which we know it performs poorly is a good way to get some idea of how good your model actually is.</p>
<p>For our dummy baseline model, instead of rib-shaped segmentations, we let the model output square segmentation maps in the rib region.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">measure</span>

<span class="k">def</span> <span class="nf">make_dummy_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">measure</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="n">dummy_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mask_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mask_locs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mask_locs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mask_locs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mask_locs</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">dummy_labels</span><span class="p">[</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span><span class="n">limits</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">dummy_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span> <span class="o">=</span> <span class="n">test_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">visualize_rib_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;original mask&#39;</span><span class="p">)</span>
<span class="n">visualize_rib_sample</span><span class="p">({</span><span class="s1">&#39;img&#39;</span><span class="p">:</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">],</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span> <span class="n">make_dummy_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">)},</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;dummy segmentation masks&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_metric_dummy</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">metric_fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function computes the average value of a metric for a data set using the dummy segmentation masks</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        dataloader (monai.data.DataLoader): dataloader wrapping the dataset to evaluate.</span>
<span class="sd">        metric_fn (function): function computing the metric value from two tensors:</span>
<span class="sd">            - a batch of outputs,</span>
<span class="sd">            - the corresponding batch of ground truth masks.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        (float) the mean value of the metric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">mean_value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">monai</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">AddChannel</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">make_dummy_sample</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="n">mean_value</span> <span class="o">+=</span> <span class="n">metric_fn</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="n">output</span><span class="p">)),</span> <span class="n">sample</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">mean_value</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean Dice: </span><span class="si">{</span><span class="n">compute_metric_dummy</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">monai</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">compute_meandice</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>Are you still happy with the performance of your model?</p>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="part-3-multilabel-classification">
<h1>Part 3: Multilabel classification<a class="headerlink" href="#part-3-multilabel-classification" title="Permalink to this heading">#</a></h1>
<div class="tip admonition">
<p class="admonition-title">Exercise</p>
<p>In the data directory, we have also placed a folder called <code class="docutils literal notranslate"><span class="pre">mask_mc</span></code> for the train, val and test set. In these images, we have labeled the left and right 7th rib. This is one of the ribs that’s most prone to fracture, and identifying exactly that rib and the side that it’s on could be valuable. Thus, this is no longer a binary label segmentation problem, but a multiclass segmentation problem. Try to also segment these images, consider what you will have to change in your code for this to work.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ⌨️ code your answer here</span>
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/Tutorial3_Segmentation"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Tutorial 3</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#may-16-2024">May 16, 2024</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#weights-and-biases">Weights and Biases</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentation-of-chest-x-ray-images">Segmentation of chest X-ray images</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-management">Data management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#build-a-cachedataset">Build a CacheDataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-visualization">Image visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-transforms">Data transforms</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dataloader">Dataloader</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#validation-set">Validation set</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-the-neural-network-loss-function-and-optimizer">Setting up the neural network, loss function, and optimizer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loss-function">Loss function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#choose-an-optimizer">Choose an optimizer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-the-training-loop">Setting up the training loop</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-the-trained-network">Evaluate the trained network</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-inspection">Visual inspection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-evaluation-metrics">Compute evaluation metrics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dice">Dice</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hausdorff-distance">Hausdorff distance</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison-to-baseline-masks">Comparison to baseline masks</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-multilabel-classification">Part 3: Multilabel classification</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Jelmer Wolterink
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>